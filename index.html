<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>THE BOX ‚Äî Gest√£o Financeira</title>
<style>
  :root{ --bg:#0b0b0b; --card:#121212; --accent:#c8102e; --muted:#9aa0a6; --ok:#16a34a; --warn:#eab308; --text: #ffffff; --input-bg: #1c1c1c; --input-border: #333; }
  *{box-sizing:border-box}
  body{ margin:0; font-family:Inter, Arial, sans-serif; background:linear-gradient(180deg,#0f1720 0%, #07101a 100%); color:var(--text); -webkit-font-smoothing:antialiased; padding:18px; min-height: 100vh; }
  
  /* Layout */
  header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap: wrap;}
  header h1{font-size:18px;margin:0}
  .container{max-width:980px;margin:0 auto}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:18px}
  .card{background:var(--card);border-radius:10px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,.5)}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  
  /* Inputs */
  input, select, textarea { 
    width:100%; padding:10px; border-radius:8px; 
    border:1px solid var(--input-border); 
    background-color: var(--input-bg) !important; 
    color: var(--text) !important; 
    margin-bottom:10px; outline: none; font-size: 14px; 
  }
  
  input:focus, select:focus { 
    border-color: var(--accent); 
    background-color: #252525 !important;
  }
  
  input::placeholder { color: #666; opacity: 1; }
  select option { background-color: var(--card); color: var(--text); }

  /* Buttons */
  button{padding:10px 12px;border-radius:8px;border:none;background:var(--accent);color:#fff;cursor:pointer;font-weight: 600;}
  button:hover{opacity: 0.9;}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,.06);font-weight: 400; color: var(--text);}
  button.link{background:transparent; color:var(--accent); padding:0; font-size:12px; margin-top:10px; text-decoration:underline;}

  /* Status Tags */
  .tag{padding:4px 8px; border-radius:4px; font-size:10px; font-weight:700; text-transform:uppercase;}
  .tag.pago{background:rgba(22, 163, 74, 0.2); color:var(--ok);}
  .tag.pendente{background:rgba(234, 179, 8, 0.2); color:var(--warn);}
  .tag.atrasado{background:rgba(200, 16, 46, 0.2); color:var(--accent);}

  /* Lists & Items */
  .list{max-height:360px;overflow:auto;margin-top:10px}
  .tx, .rec-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;margin-bottom:8px;background:linear-gradient(180deg, rgba(255,255,255,.05), transparent)}
  .tx .meta, .rec-item .meta{display:flex;gap:10px;align-items:center; color: var(--text);}
  .amount{font-weight:700} .income{color:var(--ok)} .expense{color:#ffb86b}
  .small{font-size:12px;color:var(--muted)}
  .summary{display:flex;gap:10px;margin-bottom:8px}
  .summary .s{flex:1;padding:10px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,.05), transparent)}
  canvas{width:100%;height:200px;border-radius:8px;background:transparent}
  footer{margin-top:18px;color:var(--muted);font-size:12px;text-align:center}

  /* Screens */
  #auth-container { position: fixed; top:0; left:0; width:100%; height:100%; background: #07101a; display: flex; justify-content:center; align-items:center; z-index: 9999; }
  .auth-box { width: 100%; max-width: 340px; text-align: center; border: 1px solid rgba(255,255,255,0.05); }
  
  /* CUBO 3D VERMELHO NEON NO LOGIN */
  .login-cube-container{
    width:90px;
    height:90px;
    margin:16px auto 18px;
    perspective:800px;
  }
  .login-cube{
    width:100%;
    height:100%;
    position:relative;
    transform-style:preserve-3d;
    animation:loginCubeRotate 8s infinite linear;
  }
  .login-cube .cube-face{
    position:absolute;
    width:90px;
    height:90px;
    border:2px solid var(--accent);
    background:rgba(200,16,46,0.12);
    box-shadow:0 0 22px rgba(200,16,46,0.9);
  }
  .login-cube .cube-face:nth-child(1){transform:translateZ(45px);}
  .login-cube .cube-face:nth-child(2){transform:rotateY(90deg) translateZ(45px);}
  .login-cube .cube-face:nth-child(3){transform:rotateY(180deg) translateZ(45px);}
  .login-cube .cube-face:nth-child(4){transform:rotateY(-90deg) translateZ(45px);}
  .login-cube .cube-face:nth-child(5){transform:rotateX(90deg) translateZ(45px);}
  .login-cube .cube-face:nth-child(6){transform:rotateX(-90deg) translateZ(45px);}
  @keyframes loginCubeRotate{
    0%{transform:rotateX(0deg) rotateY(0deg);}
    100%{transform:rotateX(360deg) rotateY(360deg);}
  }

  /* UI Helpers */
  .badge-demo{display:inline-block;background:#ffb86b;color:#111;padding:6px 8px;border-radius:6px;font-weight:700;margin-right:8px;font-size:12px;}
  #licenseRow{display:inline-flex;gap:8px;align-items:center}
  #licenseKey{padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,.06);background:transparent;color:var(--text)}
  #buyBtn{background:#16a34a;padding:8px 10px;border-radius:8px;color:#fff;border:none;cursor:pointer}
  #watermark-demo{position:fixed;right:10px;bottom:10px;padding:8px 12px;background:rgba(200,20,20,0.12);color:#fff;border-radius:8px;font-size:12px;backdrop-filter: blur(4px);}
  
  /* Light Theme Config */
  body[data-theme="light"]{ 
    --bg:#fff; --card:#f6f6f6; --accent:#c8102e; --muted:#6b7280; --ok:#0f766e; --text:#0b1220; 
    --input-bg: #ffffff; --input-border: #ccc;
    color:#0b1220; background:linear-gradient(180deg,#fff 0%, #f7f7f7 100%); 
  }
  body[data-theme="light"] button.ghost{ border-color: rgba(0,0,0,0.08); color:#0b1220; }
  body[data-theme="light"] #auth-container { background: #ffffff; }

  @media(max-width:900px){.grid{grid-template-columns:1fr;}.card{padding:12px}}
  select { -webkit-appearance: none; -moz-appearance: none; appearance: none; padding-right: 36px; position: relative; }
  .month-nav { display:flex;align-items:center;gap:8px }
  .month-nav button { padding:6px 8px; font-size:13px; border-radius:6px }
  
  /* Toast Notification */
  #toast { visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #333; color: #fff; text-align: center; border-radius: 2px; padding: 16px; position: fixed; z-index: 99999; left: 50%; bottom: 30px; font-size: 17px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
  #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
  @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
  @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
</style>
</head>
<body>

<div id="toast">Salvando...</div>

<input type="file" id="restoreInput" style="display:none" accept=".json" onchange="processRestore(this)">

<div id="auth-container">
  <div id="login-view" class="card auth-box">
    <!-- Cubo 3D Vermelho Neon no card de login -->
    <div class="login-cube-container">
      <div class="login-cube">
        <div class="cube-face"></div>
        <div class="cube-face"></div>
        <div class="cube-face"></div>
        <div class="cube-face"></div>
        <div class="cube-face"></div>
        <div class="cube-face"></div>
      </div>
    </div>

    <div style="font-size:24px;font-weight:800;margin-bottom:8px">THE BOX</div>
    <div style="font-size:13px;color:var(--muted);margin-bottom:24px">Gest√£o Financeira</div>
    <div style="text-align:left">
      <label>Email / Usu√°rio</label>
      <input type="text" id="loginUser" placeholder="exemplo@gmail.com">
      <label>Senha</label>
      <input type="password" id="loginPass" placeholder="****">
      <button onclick="doLogin()" style="width:100%;margin-top:10px">Entrar</button>
      <div id="loginError" style="color:var(--accent);font-size:12px;margin-top:10px;display:none">Dados incorretos.</div>
      <div style="text-align:center;margin-top:15px">
        <button class="link" onclick="toggleAuth('register')">Criar nova conta</button>
        <br>
        <button onclick="resetSystemUsers()" class="ghost" style="margin-top:20px; font-size:10px; color:var(--muted); border:none;">
          ‚ö† Resetar Todos os Usu√°rios
        </button>
      </div>
    </div>
  </div>

  <div id="register-view" class="card auth-box" style="display:none">
    <div style="font-size:24px;font-weight:800;margin-bottom:8px">Criar Conta</div>
    <div style="text-align:left">
      <label>Nome</label><input type="text" id="regName">
      <label>Email</label><input type="email" id="regEmail">
      <label>Telefone</label><input type="tel" id="regPhone">
      <label>Senha</label><input type="password" id="regPass">
      <button id="btnReg" onclick="doRegister()" style="width:100%;margin-top:10px">Cadastrar</button>
      <div id="regStatus" style="font-size:12px;margin-top:10px;text-align:center"></div>
      <div style="text-align:center;margin-top:15px">
        <button class="link" onclick="toggleAuth('login')">Voltar</button>
      </div>
    </div>
  </div>
</div>

<div id="app-content" class="container" style="display:none">
  <header>
    <div>
      <h1>THE BOX</h1>
      <div id="currentUserDisplay" class="small"></div>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <span id="commercialArea">
        <span id="demoBadge" class="badge-demo">DEMO</span>
        <button id="buyBtn" onclick="openLink()">Comprar</button>
        <span id="licenseRow">
          <input id="licenseKey" placeholder="Chave" />
          <button onclick="activateLicense()">Ativar</button>
        </span>
      </span>
      <span id="proMenu" style="display:none; gap:8px; align-items:center">
         <button id="revokeBtn" class="ghost" onclick="revokeLicense()">Resetar Licen√ßa</button>
      </span>

      <button class="ghost" onclick="openRecurring()">üìÖ Recorrentes</button>
      
      <!-- Bot√£o de Backup s√≥ aparece na PRO via checkLicense -->
      <button id="backupBtn" class="ghost" onclick="toggleBackupMenu()">üíæ Backup / Restore</button>
      
      <button id="themeToggle" class="ghost" onclick="toggleTheme()">Tema</button>
      <button class="ghost" onclick="doLogout()">Sair</button>
    </div>
  </header>

  <div id="backupMenu" class="card" style="display:none; margin-bottom:15px; padding:10px;">
     <div style="font-weight:700; margin-bottom:8px">Gerenciar Backups</div>
     <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px">
        <button id="exportJson" style="background:#0f766e; height:100%">
          <div style="font-size:14px">‚¨áÔ∏è Backup do Sistema</div>
          <div style="font-size:10px; opacity:0.8">(Salva arquivo para Restaurar)</div>
        </button>
        
        <button onclick="document.getElementById('restoreInput').click()" style="background:#eab308; color:#111; height:100%">
           <div style="font-size:14px">‚¨ÜÔ∏è Restaurar Backup</div>
           <div style="font-size:10px; opacity:0.8">(Use o arquivo do Backup do Sistema)</div>
        </button>
     </div>
     
     <hr style="border:0; border-top:1px solid rgba(255,255,255,0.1); margin:10px 0;">
     
     <div style="display:flex; gap:8px; align-items:center">
        <button id="exportCsv" class="ghost" style="font-size:12px">üìÑ Exportar Planilha (Excel)</button>
        <button id="resetAll" class="ghost" style="border-color:#c8102e; color:#c8102e; font-size:12px; margin-left:auto">Apagar Tudo</button>
     </div>
  </div>

  <main class="grid">
    <section>
      <div class="card">
        <div class="summary">
          <div class="s"><div class="small">Saldo</div><div id="saldo" style="font-size:20px;font-weight:700">R$ 0,00</div></div>
          <div class="s"><div class="small">Receitas</div><div id="receitas" style="font-size:18px;color:var(--ok)">R$ 0,00</div></div>
          <div class="s"><div class="small">Despesas</div><div id="despesas" style="font-size:18px;color:#ffb86b">R$ 0,00</div></div>
        </div>

        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px">
          <select id="filtroCategoria"><option value="">Todas categorias</option></select>
          <input type="date" id="filtroData" style="max-width:180px">
          <button id="aplicarFiltro" class="ghost">Filtrar</button>
          <button id="limparFiltro" class="ghost">Limpar</button>
        </div>

        <div class="card" style="margin-bottom:12px"><canvas id="chart" width="600" height="200"></canvas></div>

        <div class="card">
          <div style="font-weight:700;margin-bottom:10px">√öltimas Transa√ß√µes</div>
          <div id="tx-list" class="list"></div>
        </div>
      </div>
    </section>

    <aside>
      <div class="card">
        <div style="font-weight:700;margin-bottom:8px">Nova Transa√ß√£o</div>
        <label>Tipo</label><select id="tipo"><option value="expense">Despesa</option><option value="income">Receita</option></select>
        <label>Categoria</label><select id="categoria"></select>
        <button class="ghost" onclick="openCategories()" style="width:100%;margin-bottom:8px;font-size:11px">Gerenciar Categorias</button>
        <label>Descri√ß√£o</label><input type="text" id="descricao" placeholder="Ex: Pe√ßas">
        <div class="row">
          <div class="col"><label>Valor</label><input type="number" id="valor" placeholder="0.00"></div>
          <div class="col"><label>Data</label><input type="date" id="data"></div>
        </div>
        <div style="display:flex;gap:6px">
          <button id="addTx">Salvar</button>
          <button id="updateTx" style="display:none">Salvar Edi√ß√£o</button>
          <button id="cancelEdit" class="ghost" style="display:none" onclick="cancelEdit()">Cancelar</button>
        </div>
        <input type="hidden" id="editingId">
        <div style="font-size:10px; color:var(--muted); margin-top:8px; text-align:center">Dados salvos localmente.</div>
      </div>
    </aside>
  </main>
  <footer>The Box</footer>
  <footer>2026</footer>
</div>

<div id="watermark-demo" style="display:none">Vers√£o DEMO</div>

<div id="cat-page" style="display:none;max-width:600px;margin:20px auto">
  <div class="card">
    <div style="display:flex;justify-content:space-between;margin-bottom:10px">
      <strong>Categorias</strong><button class="ghost" onclick="closePages()">Voltar</button>
    </div>
    <div style="display:flex;gap:8px;margin-bottom:10px">
      <input id="newCatName" placeholder="Nova Categoria"><button onclick="addCat()">Adicionar</button>
    </div>
    <div id="cat-list"></div>
  </div>
</div>

<div id="rec-page" style="display:none;max-width:900px;margin:20px auto">
  <div class="card">
    <div style="display:flex;justify-content:space-between;margin-bottom:15px">
      <div>
        <div style="font-weight:700;font-size:18px">Contas Recorrentes</div>
        <div class="small">Gerencie contas que se repetem.</div>
      </div>
      <div style="display:flex;gap:10px;align-items:center">
        <div class="month-nav">
          <button class="ghost" onclick="prevRecMonth()" title="M√™s anterior">‚óÄ</button>
          <div id="recMonthLabel" style="font-weight:700"></div>
          <button class="ghost" onclick="nextRecMonth()" title="Pr√≥ximo m√™s">‚ñ∂</button>
        </div>
        <button class="ghost" onclick="closePages()">Voltar</button>
      </div>
    </div>
    
    <div class="summary" style="margin-bottom:15px">
      <div class="s"><div class="small">Total Recorrente</div><div id="recTotal" style="font-size:18px;font-weight:700">R$ 0,00</div></div>
      <div class="s"><div class="small">Total Pago</div><div id="recPaid" style="font-size:18px;color:var(--ok)">R$ 0,00</div></div>
      <div class="s"><div class="small">Total Pendente</div><div id="recPending" style="font-size:18px;color:var(--warn)">R$ 0,00</div></div>
    </div>

    <div class="grid">
      <div>
        <div style="font-weight:700;margin-bottom:8px">Lista de Contas M√™s</div>
        <div id="rec-list" class="list" style="max-height:500px"></div>
      </div>
      
      <div class="card" style="height:fit-content">
        <div style="font-weight:700;margin-bottom:8px" id="recFormTitle">Nova Recorrente</div>
        <label>Descri√ß√£o</label><input type="text" id="recDesc" placeholder="Ex: Energia">
        <label>Valor (R$)</label><input type="number" id="recValor">
        <div class="row">
          <div class="col"><label>Dia Venc.</label><input type="number" id="recDia" max="31"></div>
        </div>
        <div style="display:flex;gap:5px;margin-top:10px">
          <button onclick="saveRecurring()" id="btnSaveRec">Salvar Regra</button>
          <button class="ghost" onclick="resetRecForm()" style="display:none" id="btnCancelRec">Cancelar</button>
        </div>
        <input type="hidden" id="recEditId">
        <div class="small" style="margin-top:8px;color:var(--muted)">Nota: O status (Pago/Pendente) √© gerenciado na lista ao lado, individualmente por m√™s.</div>
      </div>
    </div>
  </div>
</div>

<script>
/* ==================================================
   CONFIGURA√á√ÉO DO GOOGLE SHEETS
   ================================================== */
const GOOGLE_SHEETS_URL = 'https://script.google.com/macros/s/AKfycbyBHXsDV-_E8-CjFNjL8rD0hoVqayQwzXr_Qmbi3sqoa2GB6WKqM2wWSyJxdwqN3dC_/exec';

function showToast(msg) {
  const x = document.getElementById("toast");
  x.textContent = msg; x.className = "show";
  setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
}

function syncToGoogle(payload) {
  if(!GOOGLE_SHEETS_URL || GOOGLE_SHEETS_URL.includes('COLE_SUA')) return;
  if(!payload || Object.keys(payload).length === 0) return;
  showToast("Sincronizando...");
  fetch(GOOGLE_SHEETS_URL, {
    method: 'POST', mode: 'no-cors',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  }).catch(err => console.error("Erro no envio:", err));
}

/* ==================================================
   GEST√ÉO DE DADOS & ISOLAMENTO
   ================================================== */
let currentUser = null;
let state = { tx: [], categories: [], recurring: [], licenseKey: null }; 

function getStorageKey() {
  if(!currentUser) return null;
  return 'boxmotors_data_' + currentUser.email.replace(/[^a-z0-9]/gi, '_');
}

function loadState() {
  const key = getStorageKey();
  if(!key) return;
  try {
    const raw = localStorage.getItem(key);
    if(raw) {
      state = JSON.parse(raw);
    } else {
      state = { tx:[], categories:[], recurring:[], licenseKey: null };
    }
    if(!state.recurring) state.recurring = [];
    if(!state.categories) state.categories = [];
    if(!state.tx) state.tx = [];
    if(state.licenseKey === undefined) state.licenseKey = null; 
  } catch(e) { console.error(e); }
}

function saveState() {
  const key = getStorageKey();
  if(key) localStorage.setItem(key, JSON.stringify(state));
}

/* ==================================================
   AUTENTICA√á√ÉO & LOGIN
   ================================================== */
const ADMIN_USER = { email: 'admin', pass: '1570', name: 'Administrador' };

function toggleAuth(view) {
  document.getElementById('login-view').style.display = view === 'login' ? 'block' : 'none';
  document.getElementById('register-view').style.display = view === 'register' ? 'block' : 'none';
}

function doLogin() {
  const u = document.getElementById('loginUser').value.trim();
  const p = document.getElementById('loginPass').value.trim();
  
  if(u === ADMIN_USER.email && p === ADMIN_USER.pass) { setUser(ADMIN_USER); return; }
  
  const localUsers = JSON.parse(localStorage.getItem('boxmotors_users_db') || '[]');
  const found = localUsers.find(user => user.email === u && user.pass === p);
  
  if(found) { setUser(found); } 
  else { document.getElementById('loginError').style.display = 'block'; }
}

function setUser(user) {
  state = { tx:[], categories:[], recurring:[], licenseKey: null };
  
  currentUser = user;
  sessionStorage.setItem('boxmotors_logged_user', JSON.stringify(user));
  
  document.getElementById('auth-container').style.display = 'none';
  document.getElementById('app-content').style.display = 'block';
  document.getElementById('currentUserDisplay').textContent = `Logado: ${user.name || user.email}`;
  
  loadState();
  initApp();
}

function doLogout() {
  sessionStorage.removeItem('boxmotors_logged_user');
  currentUser = null;
  location.reload();
}

function doRegister() {
  const name = document.getElementById('regName').value;
  const email = document.getElementById('regEmail').value;
  const phone = document.getElementById('regPhone').value;
  const pass = document.getElementById('regPass').value;
  const btn = document.getElementById('btnReg');
  const status = document.getElementById('regStatus');

  if(!email || !pass) return alert('Preencha email e senha.');

  btn.disabled = true; btn.textContent = "Salvando...";
  
  syncToGoogle({ action: 'register', nome: name, email: email, telefone: phone, senha: pass });

  const localUsers = JSON.parse(localStorage.getItem('boxmotors_users_db') || '[]');
  if(localUsers.find(u => u.email === email)) {
    alert('Usu√°rio j√° existe neste computador.');
    btn.disabled = false; return;
  }
  
  const newUser = { name, email, phone, pass };
  localUsers.push(newUser);
  localStorage.setItem('boxmotors_users_db', JSON.stringify(localUsers));

  status.textContent = "Sucesso! Fa√ßa login.";
  setTimeout(() => { toggleAuth('login'); btn.disabled = false; status.textContent=''; }, 2000);
}

function resetSystemUsers() {
  const password = prompt("Digite a senha do Admin para apagar todos os usu√°rios cadastrados:");
  if (password === "1570") {
    if(confirm("TEM CERTEZA? Isso excluir√° todos os logins criados.")) {
      localStorage.removeItem('boxmotors_users_db');
      alert("Base de usu√°rios resetada com sucesso!");
      location.reload();
    }
  } else if (password !== null) {
    alert("Senha incorreta.");
  }
}

/* ==================================================
   APP PRINCIPAL
   ================================================== */
const DEFAULT_CATS = ['Combust√≠vel','Pe√ßas','Servi√ßos','Marketing','Outros'];

function initApp() {
  document.getElementById('data').value = new Date().toISOString().slice(0,10);
  ensureDefaults();
  applyTheme();
  checkLicense();
  updateUI();
}

function ensureDefaults() {
  if(!state.categories || state.categories.length === 0) {
    state.categories = [...DEFAULT_CATS];
    saveState();
  }
  const opts = state.categories.map(c => `<option value="${c}">${c}</option>`).join('');
  document.getElementById('categoria').innerHTML = opts;
  document.getElementById('filtroCategoria').innerHTML = '<option value="">Todas</option>' + opts;
}

function updateUI() {
  renderTxList(); renderChart(); updateTotals(); checkLicense();
}

function uid() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }
function fmt(n) { return 'R$ ' + Number(n).toFixed(2).replace('.',','); }

document.getElementById('addTx').addEventListener('click', () => {
  if(!canAdd()) return;
  saveTx(uid());
});

document.getElementById('updateTx').addEventListener('click', () => {
  saveTx(document.getElementById('editingId').value);
});

function saveTx(id) {
  const tipo = document.getElementById('tipo').value;
  const cat = document.getElementById('categoria').value;
  const desc = document.getElementById('descricao').value.trim();
  const val = Number(document.getElementById('valor').value);
  const dt = document.getElementById('data').value;
  
  if(!val || val<=0) return alert('Valor inv√°lido');
  
  const existingIdx = state.tx.findIndex(t => t.id === id);
  
  if(currentUser) {
    syncToGoogle({
      action: 'transaction', userEmail: currentUser.email,
      tipo: tipo, categoria: cat, descricao: desc, valor: val, data: dt
    });
  }

  if(existingIdx >= 0) state.tx[existingIdx] = { id, tipo, categoria: cat, descricao: desc, valor: val, data: dt };
  else state.tx.push({ id, tipo, categoria: cat, descricao: desc, valor: val, data: dt });

  cancelEdit();
  saveState();
  updateUI();
}

function editTx(id) {
  const t = state.tx.find(x => x.id === id);
  if(!t) return;
  document.getElementById('tipo').value = t.tipo;
  document.getElementById('categoria').value = t.categoria;
  document.getElementById('descricao').value = t.descricao;
  document.getElementById('valor').value = t.valor;
  document.getElementById('data').value = t.data;
  document.getElementById('editingId').value = id;
  
  document.getElementById('addTx').style.display='none';
  document.getElementById('updateTx').style.display='inline-block';
  document.getElementById('cancelEdit').style.display='inline-block';
}

function deleteTx(id) {
  if(confirm('Apagar?')) {
    state.tx = state.tx.filter(t => t.id !== id);
    if(document.getElementById('editingId').value === id) cancelEdit();
    saveState(); updateUI();
  }
}

function cancelEdit() {
  document.getElementById('descricao').value = '';
  document.getElementById('valor').value = '';
  document.getElementById('editingId').value = '';
  document.getElementById('addTx').style.display='inline-block';
  document.getElementById('updateTx').style.display='none';
  document.getElementById('cancelEdit').style.display='none';
}

function renderTxList() {
  const el = document.getElementById('tx-list');
  el.innerHTML = '';
  const fCat = document.getElementById('filtroCategoria').value;
  const fDat = document.getElementById('filtroData').value;
  
  const list = state.tx.filter(t => {
    if(fCat && t.categoria !== fCat) return false;
    if(fDat && t.data !== fDat) return false;
    return true;
  }).sort((a,b) => b.data.localeCompare(a.data));

  list.forEach(t => {
    el.innerHTML += `
      <div class="tx">
        <div class="meta">
          <div><div style="font-weight:600">${t.descricao}</div><div class="small">${t.categoria} - ${t.data}</div></div>
        </div>
        <div style="text-align:right">
          <div class="amount ${t.tipo}">${t.tipo==='income'?'+':'-'} ${fmt(t.valor)}</div>
          <div style="margin-top:4px">
             <button class="ghost" style="font-size:10px;padding:4px" onclick="editTx('${t.id}')">Edit</button>
             <button class="ghost" style="font-size:10px;padding:4px" onclick="deleteTx('${t.id}')">Del</button>
          </div>
        </div>
      </div>`;
  });
}

function updateTotals() {
  const inc = state.tx.filter(t=>t.tipo==='income').reduce((a,b)=>a+b.valor,0);
  const exp = state.tx.filter(t=>t.tipo==='expense').reduce((a,b)=>a+b.valor,0);
  document.getElementById('saldo').textContent = fmt(inc - exp);
  document.getElementById('receitas').textContent = fmt(inc);
  document.getElementById('despesas').textContent = fmt(exp);
}

document.getElementById('aplicarFiltro').addEventListener('click', updateUI);
document.getElementById('limparFiltro').addEventListener('click', ()=>{
  document.getElementById('filtroCategoria').value='';
  document.getElementById('filtroData').value='';
  updateUI();
});

function renderChart() {
  const cv = document.getElementById('chart'); const ctx = cv.getContext('2d');
  ctx.clearRect(0,0,cv.width,cv.height);
  const sums = {}; 
  state.tx.filter(t=>t.tipo==='expense').forEach(t => sums[t.categoria] = (sums[t.categoria]||0) + t.valor);
  const data = Object.entries(sums).sort((a,b)=>b[1]-a[1]);
  
  if(!data.length) { ctx.fillStyle='#555'; ctx.fillText('Sem dados', 10,20); return; }
  
  let y=10; const max = data[0][1] || 1;
  data.forEach(([k,v], i) => {
    const w = (v/max) * (cv.width - 120);
    ctx.fillStyle = `hsl(${i*50}, 70%, 50%)`;
    ctx.fillRect(100, y, w, 20);
    ctx.fillStyle = document.body.getAttribute('data-theme') === 'light' ? '#000' : '#fff';
    ctx.fillText(k, 10, y+14);
    ctx.fillText(fmt(v), 100+w+5, y+14);
    y += 30;
  });
}

/* ==================================================
   BACKUP & EXPORT (JSON & CSV)
   ================================================== */
function toggleBackupMenu() {
  if (!isPro()) {
    alert('Fun√ß√£o dispon√≠vel apenas na vers√£o PRO.');
    return;
  }
  const m = document.getElementById('backupMenu');
  m.style.display = (m.style.display === 'none' || m.style.display === '') ? 'block' : 'none';
}

document.getElementById('exportJson').addEventListener('click', () => {
  if(!isPro()) return alert('Backup √© fun√ß√£o PRO.');
  const dataStr = JSON.stringify(state);
  downloadFile(dataStr, 'json', 'application/json');
});

document.getElementById('exportCsv').addEventListener('click', () => {
  if(!isPro()) return alert('Fun√ß√£o PRO.');
  if(!state.tx || state.tx.length === 0) return alert('Sem dados.');
  let csvContent = "\uFEFFID;Tipo;Categoria;Descri√ß√£o;Valor;Data\n";
  state.tx.forEach(row => {
     let valBr = String(row.valor).replace('.', ',');
     let desc = (row.descricao || '').replace(/"/g, '""');
     csvContent += `${row.id};${row.tipo};${row.categoria};"${desc}";${valBr};${row.data}\n`;
  });
  downloadFile(csvContent, 'csv', 'text/csv;charset=utf-8;');
});

function downloadFile(content, ext, mime) {
  const blob = new Blob([content], { type: mime });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = `boxmotors_backup_${new Date().toISOString().slice(0,10)}.${ext}`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

function processRestore(input) {
  if(!isPro()) { input.value = ''; return alert('Restaurar √© fun√ß√£o PRO.'); }
  
  const file = input.files[0];
  if (!file) return;

  if (!file.name.endsWith('.json')) {
      alert("ERRO: Por favor selecione o arquivo de Backup do Sistema (.json).\n\nO arquivo CSV (Planilha) serve apenas para o Excel e n√£o pode ser restaurado.");
      input.value = '';
      return;
  }

  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const importedState = JSON.parse(e.target.result);
      
      if(Array.isArray(importedState.tx)) {
         if(confirm("Isso ir√° SUBSTITUIR seus dados atuais pelos do backup. Continuar?")) {
            const currentLicense = state.licenseKey;
            state = importedState;
            if(currentLicense === 'BOXPRO') state.licenseKey = 'BOXPRO';
            saveState();
            alert("Dados restaurados com sucesso!");
            location.reload();
         }
      } else {
        alert("Arquivo inv√°lido.");
      }
    } catch(err) {
      alert("Erro ao ler arquivo: " + err);
    }
  };
  reader.readAsText(file);
}

/* ==================================================
   GEST√ÉO DE RECORRENTES
   ================================================== */
let recFocusDate = new Date();

function getMonthKey(d) {
  return d.getFullYear() + '-' + (d.getMonth()+1);
}

function formatMonth(d) {
  const opts = { year:'numeric', month:'long' };
  return d.toLocaleDateString('pt-BR', opts);
}
function setRecMonth(dateObj) {
  recFocusDate = new Date(dateObj.getFullYear(), dateObj.getMonth(), 1);
  document.getElementById('recMonthLabel').textContent = formatMonth(recFocusDate);
  renderRecList();
}
function prevRecMonth() {
  const d = new Date(recFocusDate); d.setMonth(d.getMonth() - 1);
  setRecMonth(d);
}
function nextRecMonth() {
  const d = new Date(recFocusDate); d.setMonth(d.getMonth() + 1);
  setRecMonth(d);
}

function openRecurring() {
  document.querySelector('main').style.display='none';
  document.getElementById('rec-page').style.display='block';
  setRecMonth(recFocusDate || new Date());
}

function closePages() {
  document.getElementById('cat-page').style.display='none';
  document.getElementById('rec-page').style.display='none';
  document.querySelector('main').style.display='grid';
  ensureDefaults(); 
}

function saveRecurring() {
  const id = document.getElementById('recEditId').value; 
  const desc = document.getElementById('recDesc').value.trim();
  const val = Number(document.getElementById('recValor').value);
  const dia = document.getElementById('recDia').value;

  if(!desc || !val) return alert('Preencha descri√ß√£o e valor.');

  if(!state.recurring) state.recurring = [];

  const existing = id ? state.recurring.find(r=>r.id===id) : null;
  const newItem = { 
    id: id || uid(), 
    desc: desc, 
    valor: val, 
    dia: dia,
    history: existing && existing.history ? existing.history : {} 
  };

  if(id) {
    const idx = state.recurring.findIndex(r => r.id === id);
    if(idx >= 0) state.recurring[idx] = newItem;
    else state.recurring.push(newItem);
  } else {
    state.recurring.push(newItem);
  }

  saveState();
  resetRecForm();
  renderRecList();
  showToast("Regra salva!");
}

function editRec(id) {
  const r = state.recurring.find(x => x.id === id);
  if(!r) return;
  document.getElementById('recDesc').value = r.desc;
  document.getElementById('recValor').value = r.valor;
  document.getElementById('recDia').value = r.dia;
  
  document.getElementById('recEditId').value = id;
  document.getElementById('recFormTitle').textContent = "Editando Regra";
  document.getElementById('btnSaveRec').textContent = "Atualizar Regra";
  document.getElementById('btnCancelRec').style.display = "inline-block";
}

function deleteRec(id) {
  if(confirm('Apagar esta regra recorrente?')) {
    state.recurring = state.recurring.filter(r => r.id !== id);
    saveState(); renderRecList();
    resetRecForm();
  }
}

function markRecPaid(id) {
  const r = state.recurring.find(x => x.id === id);
  if(!r) return;
  if(!r.history) r.history = {};
  const key = getMonthKey(recFocusDate);
  const currentStatus = r.history[key] || 'pendente';
  r.history[key] = currentStatus === 'pago' ? 'pendente' : 'pago';
  saveState();
  renderRecList();
}

function resetRecForm() {
  document.getElementById('recDesc').value='';
  document.getElementById('recValor').value='';
  document.getElementById('recDia').value='';
  document.getElementById('recEditId').value=''; 
  document.getElementById('recFormTitle').textContent = "Nova Recorrente";
  document.getElementById('btnSaveRec').textContent = "Salvar Regra";
  document.getElementById('btnCancelRec').style.display = "none";
}

function renderRecList() {
  const el = document.getElementById('rec-list');
  el.innerHTML = '';
  let total = 0, paid = 0, pending = 0;
  const key = getMonthKey(recFocusDate);

  if(state.recurring && state.recurring.length > 0) {
    state.recurring.forEach(r => {
      const statusNoMes = (r.history && r.history[key]) ? r.history[key] : 'pendente';
      total += r.valor;
      if(statusNoMes === 'pago') paid += r.valor;
      else pending += r.valor;

      const dueDay = Number(r.dia) || '-';
      el.innerHTML += `
        <div class="rec-item">
          <div class="meta">
             <div><div style="font-weight:600">${r.desc}</div><div class="small">Dia ${dueDay}</div></div>
             <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
               <span class="tag ${statusNoMes}">${statusNoMes}</span>
               <div style="display:flex;gap:6px">
                 <button class="ghost" style="font-size:12px;padding:6px" onclick="markRecPaid('${r.id}')">üëç</button>
                 <button class="ghost" style="font-size:10px;padding:4px" onclick="editRec('${r.id}')">‚úèÔ∏è</button>
                 <button class="ghost" style="font-size:10px;padding:4px" onclick="deleteRec('${r.id}')">üóëÔ∏è</button>
               </div>
             </div>
          </div>
          <div style="text-align:right"><div class="amount expense">${fmt(r.valor)}</div></div>
        </div>`;
    });
  } else {
    el.innerHTML = '<div class="small" style="text-align:center;padding:10px">Nenhuma conta fixa.</div>';
  }
  document.getElementById('recTotal').textContent = fmt(total);
  document.getElementById('recPaid').textContent = fmt(paid);
  document.getElementById('recPending').textContent = fmt(pending);
}

/* ==================================================
   CATEGORIAS & EXTRAS
   ================================================== */
function openCategories() {
  document.querySelector('main').style.display='none';
  document.getElementById('cat-page').style.display='block';
  renderCatList();
}
function addCat() {
  const n = document.getElementById('newCatName').value.trim();
  if(n && !state.categories.includes(n)) {
    state.categories.push(n);
    document.getElementById('newCatName').value='';
    saveState(); renderCatList();
  }
}
function renderCatList() {
  const el = document.getElementById('cat-list'); el.innerHTML='';
  state.categories.forEach((c, i) => {
    el.innerHTML += `<div class="tx"><span>${c}</span><button class="ghost" onclick="delCat(${i})">X</button></div>`;
  });
}
function delCat(i) {
  if(confirm('Apagar?')) {
    state.categories.splice(i,1);
    saveState(); renderCatList();
  }
}

const DEMO_LIMIT = 10;

function isPro() {
  return state.licenseKey === 'BOXPRO';
}

function checkLicense() {
  const backupBtn = document.getElementById('backupBtn');

  if(isPro()) {
    document.getElementById('demoBadge').style.display='none';
    document.getElementById('licenseKey').style.display='none';
    document.getElementById('buyBtn').style.display='none'; 
    document.getElementById('licenseRow').style.display='none'; 
    document.getElementById('proMenu').style.display='flex'; 
    document.getElementById('watermark-demo').style.display='none';
    if (backupBtn) backupBtn.style.display = 'inline-flex';
  } else {
    document.getElementById('demoBadge').style.display='inline-block';
    document.getElementById('licenseKey').style.display='inline-block';
    document.getElementById('buyBtn').style.display='inline-block';
    document.getElementById('licenseRow').style.display='inline-flex';
    document.getElementById('proMenu').style.display='none';
    document.getElementById('watermark-demo').style.display='block';
    if (backupBtn) backupBtn.style.display = 'none';
  }
}

function canAdd() {
  if(isPro()) return true;
  if(state.tx.length >= DEMO_LIMIT) {
    if(confirm('Limite DEMO atingido (10 transa√ß√µes). Adquira a vers√£o PRO.')) openLink();
    return false;
  }
  return true;
}

function activateLicense() {
  const k = document.getElementById('licenseKey').value;
  if(k === 'BOXPRO') { 
    state.licenseKey = k;
    saveState();
    alert('Licen√ßa PRO Ativada com Sucesso!');
    location.reload();
  } else alert('Chave inv√°lida');
}

function revokeLicense() {
  if(confirm("Deseja desativar a licen√ßa deste usu√°rio?")) {
    state.licenseKey = null;
    saveState();
    location.reload();
  }
}

function openLink() { window.open('https://linktr.ee/BoxMotors'); }

document.getElementById('resetAll').addEventListener('click', () => {
  if (!isPro()) {
    alert('Fun√ß√£o dispon√≠vel apenas na vers√£o PRO.');
    return;
  }
  if(confirm('TEM CERTEZA? Apagar√° todos os lan√ßamentos, categorias e recorrentes.')) {
    const savedLicense = state.licenseKey;
    state = { tx:[], categories:[...DEFAULT_CATS], recurring:[], licenseKey: savedLicense };
    saveState(); 
    location.reload();
  }
});

function applyTheme() {
  const t = localStorage.getItem('boxmotors_theme');
  if(t === 'light') document.body.setAttribute('data-theme', 'light');
  else document.body.removeAttribute('data-theme');
}
function toggleTheme() {
  const current = localStorage.getItem('boxmotors_theme');
  const next = current === 'light' ? 'dark' : 'light';
  localStorage.setItem('boxmotors_theme', next);
  applyTheme();
}

(function() {
  const storedUser = sessionStorage.getItem('boxmotors_logged_user');
  if(storedUser) {
    setUser(JSON.parse(storedUser));
  }
})();
</script>
</body>
</html>
